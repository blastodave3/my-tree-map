<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Tree Inventory Map</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        /* Mobile-First Layout */
        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100%; 
            width: 100%; 
            overflow: hidden;
            display: flex;
            flex-direction: column;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica;
        }

        #controls { 
            padding: 15px; 
            background: white; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        #map { 
            flex-grow: 1; 
            width: 100%; 
        }

        h2 { margin: 10px 0 5px 0; font-size: 1.2em; }
        p { margin: 5px 0; }

        .btn-locate {
            padding: 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            width: 100%;
            font-weight: bold;
            cursor: pointer;
        }

        /* Large Popups for Mobile Tapping */
        .leaflet-popup-content {
            font-size: 16px;
            padding: 5px;
        }
    </style>
</head>
<body>

    <div id="controls">
        <button class="btn-locate" onclick="findMe()">üìç Find My Location</button>
        <h2>üå≥ Tree Mapping Tool</h2>
        <p><strong>Status:</strong> <span id="status">Locating...</span></p>
        <p style="font-size: 0.85em; color: #666;">Tap map to add a tree at that spot.</p>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // --- 1. CONFIGURATION ---
        const SUPABASE_URL = "https://wintsbrxqxezfpxwvtxx.supabase.co";
        const SUPABASE_ANON_KEY = "sb_publishable_3nxL_MQpLTbhBFN64YA8vA_tawKXsKM";
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const statusEl = document.getElementById('status');

        // --- 2. INITIALIZE MAP ---
        const map = L.map('map');
        let userLocationLayer = null; // Variable to track the blue circle

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        // --- 3. LOCATION LOGIC ---
        function findMe() {
            statusEl.innerText = "Searching for GPS...";
            map.locate({setView: true, maxZoom: 18});
        }

        map.on('locationfound', function(e) {
            statusEl.innerText = "üìç Location Found";

            // If a blue circle already exists, remove it first
            if (userLocationLayer) {
                map.removeLayer(userLocationLayer);
            }

            // Create new blue circle and store it in the variable
            userLocationLayer = L.circle(e.latlng, { 
                radius: 10, 
                color: 'blue',
                fillColor: '#30f',
                fillOpacity: 0.4
            }).addTo(map);
        });

        map.on('locationerror', function(e) {
            statusEl.innerText = "‚ùå GPS Error / Denied";
            // Default view if GPS fails
            if (!map.getCenter()) map.setView([40.7128, -74.0060], 13);
        });

        // Trigger auto-locate on start
        setTimeout(findMe, 500);

        // --- 4. LOAD TREES FROM DATABASE ---
        async function loadTrees() {
            try {
                const { data: trees, error } = await supabaseClient
                    .from('tree_points')
                    .select('*');

                if (error) throw error;

                if (trees) {
                    trees.forEach(tree => {
                        L.marker([tree.latitude, tree.longitude])
                            .addTo(map)
                            .bindPopup(`<b>Tree:</b> ${tree.tree_type || 'Unknown'}`);
                    });
                }
            } catch (err) {
                console.error("Load Error:", err);
                statusEl.innerText = "‚ùå Error loading trees";
            }
        }

        // --- 5. ADD TREE ON MAP TAP ---
        map.on('click', async function(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;

            const userInput = prompt("What kind of tree is this?");
            if (!userInput) return;

            // Show temporary marker immediately
            const tempMarker = L.marker([lat, lng]).addTo(map).bindPopup("Saving...").openPopup();

            const { error } = await supabaseClient
                .from('tree_points')
                .insert([{ 
                    tree_type: userInput, 
                    latitude: lat, 
                    longitude: lng 
                }]);

            if (error) {
                alert("Database Error: " + error.message);
                map.removeLayer(tempMarker);
            } else {
                tempMarker.setPopupContent(`<b>Tree:</b> ${userInput}`);
            }
        });

        loadTrees();
    </script>
</body>
</html>
<script>
    // --- CONFIGURATION ---
    const SUPABASE_URL = "https://wintsbrxqxezfpxwvtxx.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_3nxL_MQpLTbhBFN64YA8vA_tawKXsKM";

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const statusEl = document.getElementById('status');

    // --- INITIALIZE MAP ---
    const map = L.map('map');

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
    }).addTo(map);

    // --- AUTO-LOCATION LOGIC ---
    map.locate({setView: true, maxZoom: 18});

    // Combined location handler
    map.on('locationfound', function(e) {
        statusEl.innerText = "üìç Location Found. Tap map to add a tree.";
        L.circle(e.latlng, { radius: 10, color: 'blue' }).addTo(map);
    });

    map.on('locationerror', function(e) {
        statusEl.innerText = "‚ùå GPS Denied. Please enable location.";
        map.setView([40.7128, -74.0060], 13); // Default to NYC
    });

    // Helper for the button
    function findMe() {
        map.locate({setView: true, maxZoom: 16});
    }

    // --- LOAD DATA FROM DATABASE ---
    async function loadTrees() {
        try {
            const { data: trees, error } = await supabaseClient
                .from('tree_points')
                .select('*');

            if (error) throw error;

            if (trees) {
                trees.forEach(tree => {
                    L.marker([tree.latitude, tree.longitude])
                        .addTo(map)
                        .bindPopup(`<b>Tree:</b> ${tree.tree_type || 'Unknown'}`);
                });
                statusEl.innerText = "‚úÖ Trees Loaded";
            }
        } catch (err) {
            console.error(err);
            statusEl.innerText = "‚ùå Error loading trees.";
        }
    } // <--- This was the bracket missing in your code!

    // --- ADD DATA ON CLICK ---
    map.on('click', async function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;

        const userInput = prompt("What kind of tree is this?");
        if (!userInput) return;

        const tempMarker = L.marker([lat, lng]).addTo(map).bindPopup("Saving...").openPopup();

        const { error } = await supabaseClient
            .from('tree_points')
            .insert([{ 
                tree_type: userInput, 
                latitude: lat, 
                longitude: lng 
            }]);

        if (error) {
            alert("Database Error: " + error.message);
            map.removeLayer(tempMarker);
        } else {
            tempMarker.setPopupContent(`<b>Tree:</b> ${userInput}`);
        }
    });

    loadTrees();
</script>